---
title: "Rapport d'étude RMarkdown"
author: "Anthony et Lucas"
date: "2024-09-20"
output:
  html_document:
    df_print: paged
params:
  code_postal: 73*
  type_logement: les deux
---
*Le Rmarkdown présenté ci-dessous représente une automatisation du code Rshiny sur le web qui permet de choisir son code postal et son type de logement dans les paramètres juste au dessus, ce document permet de voir quelques KPI, graphiques et statistiques bivariés entre les informations qui sont mis à disposition par l'API du site de l'Etat.*

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(httr)
library(jsonlite)
library(dplyr)
library(ggplot2)
```

# Extraction des données logements

```{r include=TRUE}
code_postal <- params$code_postal
type_logement <- params$type_logement
size <- 10000  # Taille des paquets

# Créer des dataframes vides pour stocker les résultats
df_existants <- data.frame()
df_neufs <- data.frame()

# Récupération des logements existants si le type sélectionné est "ancien" ou "les deux"
if (type_logement == "ancien" || type_logement == "les deux") {
  Date_existants <- 2021  #Avant 2021 il n'y a pas de data dans l'API
  base_url_existants <- "https://data.ademe.fr/data-fair/api/v1/datasets/dpe-v2-logements-existants/lines"
  
  repeat {
    params_existants <- list(
      page = 1,
      size = size,
      select = "N°DPE,Etiquette_DPE,Date_réception_DPE,Coordonnée_cartographique_Y_(BAN),Coordonnée_cartographique_X_(BAN),Identifiant__BAN,Année_construction,Type_bâtiment,Type_installation_chauffage,Surface_habitable_logement",
      q = code_postal,
      q_fields = "Code_postal_(BAN)",
      qs = paste0("Date_réception_DPE:[", Date_existants, "-01-01 TO ", Date_existants, "-12-31]")
    )
    
    url_encoded_existants <- modify_url(base_url_existants, query = params_existants)
    response_existants <- GET(url_encoded_existants)
    
    if (status_code(response_existants) != 200) {
      stop("Erreur dans la requête : ", status_code(response_existants))
    }
    
    content_existants <- fromJSON(rawToChar(response_existants$content), flatten = FALSE)
    data_existants <- content_existants$result
    df_existants <- rbind(df_existants, data_existants)
    
    Date_existants <- Date_existants + 1
    if (Date_existants == 2030) break
    
    Sys.sleep(1)
  }
  
  df_existants$type_logement <- "Existant"
}

# Récupération des logements neufs si le type sélectionné est "neuf" ou "les deux"
if (type_logement == "neuf" || type_logement == "les deux") {
  Date_neufs <- 2021
  base_url_neufs <- "https://data.ademe.fr/data-fair/api/v1/datasets/dpe-v2-logements-neufs/lines"
  
  repeat {
    params_neufs <- list(
      page = 1,
      size = size,
      select = "N°DPE,Etiquette_DPE,Date_réception_DPE,Coordonnée_cartographique_Y_(BAN),Coordonnée_cartographique_X_(BAN),Identifiant__BAN,Type_bâtiment,Type_installation_chauffage,Surface_habitable_logement",
      q = code_postal,
      q_fields = "Code_postal_(BAN)",
      qs = paste0("Date_réception_DPE:[", Date_neufs, "-01-01 TO ", Date_neufs, "-12-31]")
    )
    
    url_encoded_neufs <- modify_url(base_url_neufs, query = params_neufs)
    response_neufs <- GET(url_encoded_neufs)
    
    if (status_code(response_neufs) != 200) {
      stop("Erreur dans la requête : ", status_code(response_neufs))
    }
    
    content_neufs <- fromJSON(rawToChar(response_neufs$content), flatten = FALSE)
    data_neufs <- content_neufs$result
    df_neufs <- rbind(df_neufs, data_neufs)
    
    Date_neufs <- Date_neufs + 1
    if (Date_neufs == 2030) break
    
    Sys.sleep(1) 
  }
  
  df_neufs$type_logement <- "Neufs"
  df_neufs$Année_construction <- NA
}
```

# Fusion des données

```{r include=TRUE}
# Fusionner les données si l'utilisateur a choisi "les deux"
if (type_logement == "les deux") {
  df_logement <- rbind(df_existants, df_neufs)
} else if (type_logement == "ancien") {
  df_logement <- df_existants
} else {
  df_logement <- df_neufs
}

# Nettoyage des données
df_logement <- df_logement[!is.na(df_logement$`Coordonnée_cartographique_X_(BAN)`) &
                             !is.na(df_logement$`Coordonnée_cartographique_Y_(BAN)`), ]
```

## KPI

### Répartition des logements existants/neufs

```{r echo=FALSE}
kpi_type <- df_logement %>% 
  group_by(type_logement) %>% 
  summarise(count = n())

ggplot(kpi_type, aes(x = type_logement, y = count, fill = type_logement)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "Répartition des logements par type", y = "Nombre de logements", x = "")
```

On observe une plus grosse part de logements Existants que de neufs

### Comparaison des étiquettes DPE en fonction du logement (neuf ou existant)

```{r echo=FALSE}
# Graphique à barres empilées pour comparer les étiquettes DPE
ggplot(df_logement, aes(x = Etiquette_DPE, fill = type_logement)) +
  geom_bar(position = "dodge") + 
  theme_minimal() +
  labs(title = "Comparaison des étiquettes DPE entre les logements existants et neufs",
       x = "Etiquette DPE",
       y = "Nombre de logements",
       fill = "Type de logement") +
  theme(legend.position = "right")
```


On remarque que les logements neufs sont plus souvent d'une bonne DPE par rapport aux logements anciens

### Distribution des étiquettes DPE

```{r echo=FALSE}

colors_dpe <- c(
  "A" = "#006400",  
  "B" = "#32CD32",  
  "C" = "#ADFF2F",  
  "D" = "#FFD700",  
  "E" = "#FFA500", 
  "F" = "#FF8C00", 
  "G" = "#FF0000")  

# Calcul des KPI pour les étiquettes DPE 
kpi_dpe <- df_logement %>% 
  group_by(Etiquette_DPE) %>% 
  summarise(count = n()) %>% 
  arrange(desc(count))

kpi_dpe$Etiquette_DPE <- factor(kpi_dpe$Etiquette_DPE, levels = c("G", "F", "E", "D", "C", "B", "A"))

# Visualisation avec barres horizontales
ggplot(kpi_dpe, aes(x = Etiquette_DPE, y = count, fill = Etiquette_DPE)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = colors_dpe) +  
  coord_flip() +  # Faire en sorte que les barres soient horizontales
  theme_minimal() +
  labs(title = "Distribution des étiquettes DPE", y = "Nombre de logements", x = "Etiquette DPE")

```

On remarque que les étiquettes des logements tournent autour de C, D et E

### Calcul de la corrélation entre l'année de construction et l'étiquette DPE

```{r echo=FALSE}
# Convertir l'étiquette DPE en une variable numérique
df_existants$DPE_num <- as.numeric(factor(df_existants$Etiquette_DPE, levels = c("A", "B", "C", "D", "E", "F", "G")))

# Calcul de la corrélation entre l'année de construction et l'étiquette DPE
correlation <- cor(df_existants$Année_construction, df_existants$DPE_num, use = "complete.obs")

correlation
```
La corrélation est négative, on en déduit donc que plus un bâtiment est récent, plus son étiquette DPE tend à être meilleure.

Avec une valeur aussi faible cela signifie que la date de construction n'est pas ce qui influe le plus sur l'étiquette de DPE. Les matériaux utilisé avant ne sont pas tellement différents d'aujourd'hui.

### Répartition des types d'installation de chauffage

```{r echo=FALSE}
# Calcul de la répartition des types d'installation de chauffage
kpi_chauffage <- df_logement %>%
  group_by(Type_installation_chauffage) %>%
  summarise(count = n()) %>%
  mutate(percentage = round((count / sum(count)) * 100, 2)) %>%
  arrange(desc(count))

#Affichage des pourcentages
print(kpi_chauffage)

# Visualisation de la répartition par type d'installation de chauffage
ggplot(kpi_chauffage, aes(x = reorder(Type_installation_chauffage, -count), y = percentage, fill = Type_installation_chauffage)) +
  geom_bar(stat = "identity") +
  coord_flip() +  # Pour un graphique horizontal
  theme_minimal() +
  labs(title = "Répartition des types d'installation de chauffage", 
       y = "Pourcentage", x = "Type d'installation de chauffage") +
  theme(legend.position = "none")
```


### Corrélation entre le type de chauffage et l'étiquette DPE

```{r echo=FALSE}

# Encodage en numerique
df_existants$Chauffage_code <- as.numeric(as.factor(df_existants$Type_installation_chauffage))

# Calculer 
correlation_chauffage_annee <- cor(df_existants$Chauffage_code, df_existants$Année_construction, use = "complete.obs")

# Corrélation entre le type de chauffage et l'étiquette DPE
df_existants$Etiquette_DPE_code <- as.numeric(as.factor(df_existants$Etiquette_DPE))
correlation_chauffage_dpe <- cor(df_existants$Chauffage_code, df_existants$Etiquette_DPE_code, use = "complete.obs")

cat("Corrélation entre le type de chauffage et l'étiquette DPE :", correlation_chauffage_dpe, "\n")
```

Cette corrélation reste assez faible donc on ne peut pas dire que le type d'affichage influe beacoup sur la note du DPE

### Nuage de points des répartitions par surface habitable

```{r echo=FALSE}
df_logement_clean <- df_logement %>%
  filter(!is.na(Etiquette_DPE) & !is.na(Surface_habitable_logement))

df_logement_clean$Etiquette_DPE <- factor(df_logement_clean$Etiquette_DPE, 
                                           levels = c("A", "B", "C", "D", "E", "F", "G"))

# Créer un nuage de points pour la surface habitable en fonction de l'étiquette DPE
ggplot(df_logement_clean, aes(x = Etiquette_DPE, 
                                y = Surface_habitable_logement, 
                                color = Type_bâtiment)) +
  geom_point(alpha = 0.6, size = 2) +
  theme_minimal() +
  labs(title = "Nuage de Points: Surface Habitable par Type de Bâtiment",
       x = "Étiquette DPE",
       y = "Surface Habitable (m²)",
       color = "Type de Bâtiment") +
  theme(legend.position = "right")
```
On remarque que les immeubles voir même les appartements ont plus tendance à avoir une meilleur note de DPE que les maison qui sont elles, beaucoup mieux étalé.

### Corrélation entre l'étiquette de DPE et la surface habitable 

```{r echo=FALSE}
# Convertir l'étiquette DPE en valeurs numériques
df_logement$DPE_numeric = as.numeric(factor(df_logement$Etiquette_DPE, 
                                              levels = c("A", "B", "C", "D", "E", "F", "G")))

# Calculer la corrélation
correlation = cor(df_logement$Surface_habitable_logement, df_logement$DPE_numeric, use = "complete.obs")
print(correlation)
```


