---
title: "Rapport d'étude RMarkdown"
author: "Anthony et Lucas"
date: "2024-09-20"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(httr)
library(jsonlite)
library(dplyr)
library(ggplot2)
```

#Extraction des données logements

##Récupération des logements Existants
```{r include=TRUE}
code_postal <- "73*"
size <- 10000  # Taille des paquets
df_existants <- data.frame()  # Dataframe pour stocker les résultats des logements existants
Date_existants <- 2021  # Filtrer à partir de cette date
base_url_existants <- "https://data.ademe.fr/data-fair/api/v1/datasets/dpe-v2-logements-existants/lines"

repeat {
  params <- list(
    page = 1,
    size = size,
    select = "N°DPE,Etiquette_DPE,Date_réception_DPE,Coordonnée_cartographique_Y_(BAN),Coordonnée_cartographique_X_(BAN),Identifiant__BAN,Année_construction,Type_bâtiment,Type_installation_chauffage,Surface_habitable_logement,Qualité_isolation_murs",
    q = code_postal,
    q_fields = "Code_postal_(BAN)",
    qs = paste0("Date_réception_DPE:[", Date_existants, "-01-01 TO ", Date_existants, "-12-31]")
  )
  
  url_encoded <- modify_url(base_url_existants, query = params)
  response <- GET(url_encoded)
  
  if (status_code(response) != 200) {
    stop("Erreur dans la requête : ", status_code(response))
  }
  
  content <- fromJSON(rawToChar(response$content), flatten = FALSE)
  data <- content$result
  df_existants <- rbind(df_existants, data)
  
  Date_existants <- Date_existants + 1
  if (Date_existants == 2030) break
  
  Sys.sleep(1)  # Pause de 1 seconde entre les requêtes
}
df_existants$type_logement <- "Existant"
```

##Récupération des logements neufs

```{r include=TRUE}
df_neufs <- data.frame()  # Dataframe pour stocker les résultats des logements neufs
Date_neufs <- 2021
base_url_neufs <- "https://data.ademe.fr/data-fair/api/v1/datasets/dpe-v2-logements-neufs/lines"

repeat {
  params <- list(
    page = 1,
    size = size,
    select = "N°DPE,Etiquette_DPE,Date_réception_DPE,Coordonnée_cartographique_Y_(BAN),Coordonnée_cartographique_X_(BAN),Identifiant__BAN,Type_bâtiment,Type_installation_chauffage,Surface_habitable_logement,Qualité_isolation_murs",
    q = code_postal,
    q_fields = "Code_postal_(BAN)",
    qs = paste0("Date_réception_DPE:[", Date_neufs, "-01-01 TO ", Date_neufs, "-12-31]")
  )
  
  url_encoded <- modify_url(base_url_neufs, query = params)
  response <- GET(url_encoded)
  
  if (status_code(response) != 200) {
    stop("Erreur dans la requête : ", status_code(response))
  }
  
  content <- fromJSON(rawToChar(response$content), flatten = FALSE)
  data <- content$result
  df_neufs <- rbind(df_neufs, data)
  
  Date_neufs <- Date_neufs + 1
  if (Date_neufs == 2030) break
  
  Sys.sleep(1)  # Pause de 1 seconde entre les requêtes
}
df_neufs$type_logement = "Neufs"
df_neufs$Année_construction = NA
```

#Fusion des données

```{r include=TRUE}
df_logement <- rbind(df_existants, df_neufs)

# Nettoyage des données
df_logement <- df_logement[!is.na(df_logement$`Coordonnée_cartographique_X_(BAN)`) &
                             !is.na(df_logement$`Coordonnée_cartographique_Y_(BAN)`), ]
```
#KPI

##Répartition des logements existants/neufs

```{r}
kpi_type <- df_logement %>% 
  group_by(type_logement) %>% 
  summarise(count = n())

ggplot(kpi_type, aes(x = type_logement, y = count, fill = type_logement)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "Répartition des logements par type", y = "Nombre de logements", x = "")
```
###On observe une plus grosse part de logements Existants que de neufs

##Distribution des étiquettes DPE

```{r}
# Créer une palette de couleurs pour les étiquettes DPE
colors_dpe <- c(
  "A" = "#006400",  # Vert foncé
  "B" = "#32CD32",  # Vert clair
  "C" = "#ADFF2F",  # Vert jaune
  "D" = "#FFD700",  # Jaune
  "E" = "#FFA500",  # Orange
  "F" = "#FF8C00",  # Orange foncé
  "G" = "#FF0000"   # Rouge
)

# Calcul des KPI pour les étiquettes DPE et garder l'ordre de A à G
kpi_dpe <- df_logement %>% 
  group_by(Etiquette_DPE) %>% 
  summarise(count = n()) %>% 
  arrange(desc(count))

# Transformer la colonne Etiquette_DPE en facteur avec l'ordre souhaité
kpi_dpe$Etiquette_DPE <- factor(kpi_dpe$Etiquette_DPE, levels = c("G", "F", "E", "D", "C", "B", "A"))

# Visualisation avec barres horizontales et couleurs personnalisées
ggplot(kpi_dpe, aes(x = Etiquette_DPE, y = count, fill = Etiquette_DPE)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = colors_dpe) +  # Appliquer les couleurs personnalisées
  coord_flip() +  # Faire en sorte que les barres soient horizontales
  theme_minimal() +
  labs(title = "Distribution des étiquettes DPE", y = "Nombre de logements", x = "Etiquette DPE")

```
### On remarque que les étiquettes des logements tournent autour de C, D et E

#Calcul de la corrélation entre l'année de construction et l'étiquette DPE

```{r}
# Convertir l'étiquette DPE en une variable numérique
df_existants$DPE_num <- as.numeric(factor(df_existants$Etiquette_DPE, levels = c("A", "B", "C", "D", "E", "F", "G")))

# Calcul de la corrélation entre l'année de construction et l'étiquette DPE
correlation <- cor(df_existants$Année_construction, df_existants$DPE_num, use = "complete.obs")

correlation
```
##La corrélation est négative, on en déduit donc que plus un bâtiment est récent, plus son étiquette DPE tend à être meilleure.
##Avec une valeur aussi faible cela signifie que la date de construction n'est pas ce qui influe le plus sur l'étiquette de DPE. Les matériaux utilisé avant ne sont pas tellement différents d'aujourd'hui.

#Répartition des types d'installation de chauffage
```{r}
# Calcul de la répartition des types d'installation de chauffage
kpi_chauffage <- df_logement %>%
  group_by(Type_installation_chauffage) %>%
  summarise(count = n()) %>%
  mutate(percentage = round((count / sum(count)) * 100, 2)) %>%
  arrange(desc(count))

# Affichage du KPI
print(kpi_chauffage)

# Visualisation de la répartition par type d'installation de chauffage
ggplot(kpi_chauffage, aes(x = reorder(Type_installation_chauffage, -count), y = percentage, fill = Type_installation_chauffage)) +
  geom_bar(stat = "identity") +
  coord_flip() +  # Pour un graphique horizontal
  theme_minimal() +
  labs(title = "Répartition des types d'installation de chauffage", 
       y = "Pourcentage", x = "Type d'installation de chauffage") +
  theme(legend.position = "none")
```

#Corrélation entre le type de chauffage et l'étiquette DPE
```{r}

# Encodage en numerique
df_existants$Chauffage_code <- as.numeric(as.factor(df_existants$Type_installation_chauffage))

# Calculer 
correlation_chauffage_annee <- cor(df_existants$Chauffage_code, df_existants$Année_construction, use = "complete.obs")

# Corrélation entre le type de chauffage et l'étiquette DPE
df_existants$Etiquette_DPE_code <- as.numeric(as.factor(df_existants$Etiquette_DPE))
correlation_chauffage_dpe <- cor(df_existants$Chauffage_code, df_existants$Etiquette_DPE_code, use = "complete.obs")

cat("Corrélation entre le type de chauffage et l'étiquette DPE :", correlation_chauffage_dpe, "\n")
```
##Cette corrélation reste assez faible donc on ne peut pas dire que le type d'affichage influe beacoup sur la note du DPE

#Nuage de points des répartitions par surface habitable

```{r}
# Créer un nuage de points pour la surface habitable en fonction de l'étiquette DPE
ggplot(df_logement, aes(x = Etiquette_DPE, 
                         y = Surface_habitable_logement, 
                         color = Type_bâtiment)) +
  geom_point(alpha = 0.6, size = 2) +  # alpha pour la transparence, size pour la taille des points
  theme_minimal() +
  labs(title = "Nuage de Points: Surface Habitable par Type de Bâtiment",
       x = "Étiquette DPE",
       y = "Surface Habitable (m²)",
       color = "Type de Bâtiment") +
  theme(legend.position = "right")  # Positionner la légende à droite
```

```{r}
# Convertir l'étiquette DPE en valeurs numériques
df_logement$DPE_numeric <- as.numeric(factor(df_logement$Etiquette_DPE, 
                                              levels = c("A", "B", "C", "D", "E", "F", "G")))

# Calculer la corrélation
correlation <- cor(df_logement$Surface_habitable_logement, df_logement$DPE_numeric, use = "complete.obs")
print(correlation)
```

#Comparaison de l'Étiquette DPE et de la Qualité d'Isolation des Murs

